{% extends "base.html" %}

{# ---- Títulos y metas con fallbacks seguros ---- #}
{% set _desc = (product.short_description or (product.description or '')[:160]) %}
{% block title %}{{ product.name }} - {{ app_name }}{% endblock %}
{% block meta_description %}{{ _desc }}{% endblock %}
{% block og_title %}{{ product.name }}{% endblock %}
{% block og_description %}{{ _desc }}{% endblock %}

{% block content %}
{# Normaliza colecciones/valores que pueden venir de distintas fuentes o nulos #}
{% set images_list = (product.images if product.images is not none else (images if images is defined else [])) or [] %}
{% set variants_list = (product.variants if product.variants is not none else (variants if variants is defined else [])) or [] %}
{% set specs = (technical_specs if technical_specs is defined and technical_specs else product.technical_specs) %}
{% set visible_price = product.sale_price if product.sale_price else product.base_price %}
{% set has_offer = product.sale_price is not none and product.sale_price != 0 and product.base_price and product.base_price > 0 %}
{% set discount_pct = ((product.base_price - product.sale_price) / product.base_price * 100) | int if has_offer else 0 %}

<div class="container-custom py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3 text-sm">
            <li><a href="{{ url_for('main.index') }}" class="text-gray-700 hover:text-primary-600">Inicio</a></li>
            <li><span class="text-gray-400 mx-2">/</span></li>
            <li><a href="{{ url_for('catalog.index') }}" class="text-gray-700 hover:text-primary-600">Catálogo</a></li>
            {% if product.category %}
                <li><span class="text-gray-400 mx-2">/</span></li>
                <li><a href="{{ url_for('catalog.category', slug=product.category.slug) }}" class="text-gray-700 hover:text-primary-600">{{ product.category.name }}</a></li>
            {% endif %}
            <li><span class="text-gray-400 mx-2">/</span></li>
            <li><span class="text-gray-500">{{ product.name }}</span></li>
        </ol>
    </nav>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Product Images -->
        <div>
            <!-- Main Image -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
                <div class="aspect-square relative">
                    {% if images_list and images_list|length > 0 and images_list[0].url %}
                        <img id="mainImage" 
                             src="{{ images_list[0].url }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-gray-100">
                            <svg class="w-32 h-32 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    {% endif %}
                    
                    <!-- Sale Badge -->
                    {% if has_offer %}
                        <div class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                            OFERTA -{{ discount_pct }}%
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Thumbnail Gallery -->
            {% if images_list|length > 1 %}
                <div class="grid grid-cols-4 gap-2">
                    {% for image in images_list %}
                        {% if image.url %}
                        <button onclick="changeMainImage('{{ image.url }}')" 
                                class="aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-primary-500 transition-colors">
                            <img src="{{ image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                        </button>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <!-- Brand -->
                {% if product.brand %}
                    <p class="text-sm text-gray-500 mb-2">{{ product.brand.name }}</p>
                {% endif %}
                
                <!-- Name -->
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ product.name }}</h1>
                
                <!-- SKU -->
                {% if product.sku %}
                <p class="text-sm text-gray-500 mb-4">SKU: {{ product.sku }}</p>
                {% endif %}
                
                <!-- Price -->
                <div class="mb-6">
                    {% if has_offer %}
                        <div class="flex items-baseline space-x-3">
                            <span class="text-4xl font-bold text-red-600">{{ product.sale_price|currency }}</span>
                            <span class="text-2xl text-gray-400 line-through">{{ product.base_price|currency }}</span>
                        </div>
                        <p class="text-sm text-green-600 mt-1">Ahorras {{ (product.base_price - product.sale_price)|currency }}</p>
                    {% else %}
                        <span class="text-4xl font-bold text-gray-900">{{ visible_price|currency }}</span>
                    {% endif %}
                </div>
                
                <!-- Short Description -->
                {% if product.short_description %}
                    <p class="text-gray-700 mb-6">{{ product.short_description }}</p>
                {% endif %}
                
                <!-- Variants -->
                {% if variants_list and variants_list|length > 0 %}
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-900 mb-2">Selecciona una opción:</label>
                        <select id="variantSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                            {% for variant in variants_list %}
                                {% if variant.is_active %}
                                    <option value="{{ variant.id }}" 
                                            data-stock="{{ variant.stock }}"
                                            data-price="{{ variant.price_adjustment }}">
                                        {{ variant.name }} 
                                        {% if variant.stock > 0 %}
                                            ({{ variant.stock }} disponibles)
                                        {% else %}
                                            (Agotado)
                                        {% endif %}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                
                <!-- Quantity -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-900 mb-2">Cantidad:</label>
                    <div class="flex items-center space-x-3">
                        <button onclick="decrementQuantity()" class="w-10 h-10 border border-gray-300 rounded-lg hover:bg-gray-50">
                            <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <input type="number" id="quantity" value="1" min="1" max="99" 
                               class="w-20 text-center px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        <button onclick="incrementQuantity()" class="w-10 h-10 border border-gray-300 rounded-lg hover:bg-gray-50">
                            <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Stock Status -->
                {% set total_stock = variants_list|sum(attribute='stock') if variants_list else 0 %}
                <div class="mb-6">
                    {% if total_stock > 0 %}
                        <div class="flex items-center text-green-600">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-medium">En stock ({{ total_stock }} disponibles)</span>
                        </div>
                    {% else %}
                        <div class="flex items-center text-red-600">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span class="font-medium">Producto agotado</span>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Action Buttons -->
                <div class="space-y-3">
                    {% if total_stock > 0 %}
                        <button onclick="addToCart()" 
                                class="w-full bg-primary-600 text-white py-4 rounded-lg hover:bg-primary-700 transition-colors font-semibold text-lg">
                            Agregar al Carrito
                        </button>
                        
                        <a href="{{ url_for('checkout.index') }}?product={{ product.id }}" 
                           class="block w-full bg-accent-500 text-white py-4 rounded-lg hover:bg-accent-600 transition-colors font-semibold text-lg text-center">
                            Comprar Ahora
                        </a>
                    {% else %}
                        <button disabled class="w-full bg-gray-300 text-gray-500 py-4 rounded-lg cursor-not-allowed font-semibold text-lg">
                            No Disponible
                        </button>
                    {% endif %}
                    
                    <!-- WhatsApp Button -->
                    {% if whatsapp_phone %}
                    <a href="https://wa.me/{{ whatsapp_phone.replace('+', '') }}?text=Hola, estoy interesado en: {{ product.name }} - {{ request.url }}" 
                       target="_blank"
                       class="flex items-center justify-center w-full bg-green-500 text-white py-4 rounded-lg hover:bg-green-600 transition-colors font-semibold">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        Consultar por WhatsApp
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Details Tabs -->
    <div class="bg-white rounded-lg shadow-sm mb-12">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button onclick="showTab('description')" id="tab-description" 
                        class="tab-button active px-6 py-4 text-sm font-medium border-b-2 border-primary-600 text-primary-600">
                    Descripción
                </button>
                {% if specs %}
                    <button onclick="showTab('specs')" id="tab-specs" 
                            class="tab-button px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Especificaciones
                    </button>
                {% endif %}
            </nav>
        </div>
        
        <div class="p-6">
            <!-- Description Tab -->
            <div id="content-description" class="tab-content">
                <div class="prose max-w-none">
                    {{ product.description|safe if product.description else 'Sin descripción disponible.' }}
                </div>
            </div>
            
            <!-- Specs Tab -->
            {% if specs %}
                <div id="content-specs" class="tab-content hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="divide-y divide-gray-200">
                            {% for key, value in specs.items() %}
                                <tr>
                                    <td class="py-3 pr-6 text-sm font-medium text-gray-900 w-1/3">{{ key }}</td>
                                    <td class="py-3 text-sm text-gray-700">{{ value }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products and related_products|length > 0 %}
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Productos Relacionados</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% for related in related_products[:4] %}
                    {% set related_has_offer = related.sale_price is not none and related.sale_price != 0 %}
                    {% set related_visible_price = related.sale_price if related_has_offer else related.base_price %}
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                        <a href="{{ url_for('catalog.product_detail', slug=related.slug) }}">
                            <div class="aspect-square bg-gray-100">
                                {% if related.images and related.images[0] and related.images[0].url %}
                                    <img src="{{ related.images[0].url }}" alt="{{ related.name }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                                        <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="p-4">
                                <h3 class="text-sm font-medium text-gray-900 mb-2 line-clamp-2">{{ related.name }}</h3>
                                <p class="text-lg font-bold text-gray-900">
                                    {{ related_visible_price|currency }}
                                    {% if related_has_offer %}
                                        <span class="text-sm text-gray-400 line-through ml-2">{{ related.base_price|currency }}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function changeMainImage(url) {
        const el = document.getElementById('mainImage');
        if (el && url) el.src = url;
    }
    
    function incrementQuantity() {
        const input = document.getElementById('quantity');
        if (!input) return;
        const max = parseInt(input.max || '99', 10);
        const current = parseInt(input.value || '1', 10);
        if (current < max) input.value = current + 1;
    }
    
    function decrementQuantity() {
        const input = document.getElementById('quantity');
        if (!input) return;
        const min = parseInt(input.min || '1', 10);
        const current = parseInt(input.value || '1', 10);
        if (current > min) input.value = current - 1;
    }
    
    function addToCart() {
        const quantity = parseInt((document.getElementById('quantity') || {value: '1'}).value, 10);
        const variantSelect = document.getElementById('variantSelect');
        const variantId = variantSelect ? variantSelect.value : null;
        
        fetch('/carrito/agregar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                product_id: '{{ product.id }}',
                variant_id: variantId,
                quantity: quantity
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data && data.success) {
                const cartCount = document.querySelector('[data-cart-count]');
                if (cartCount && typeof data.cart_count !== 'undefined') {
                    cartCount.textContent = data.cart_count;
                }
                showNotification('Producto agregado al carrito', 'success');
            } else {
                showNotification((data && data.message) || 'Error al agregar al carrito', 'error');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showNotification('Error al agregar al carrito', 'error');
        });
    }
    
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(b => {
            b.classList.remove('active', 'border-primary-600', 'text-primary-600');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        const content = document.getElementById('content-' + tabName);
        const button = document.getElementById('tab-' + tabName);
        if (content) content.classList.remove('hidden');
        if (button) {
            button.classList.add('active', 'border-primary-600', 'text-primary-600');
            button.classList.remove('border-transparent', 'text-gray-500');
        }
    }
    
    function showNotification(message, type) {
        const n = document.createElement('div');
        n.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-slideDown ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white`;
        n.textContent = message;
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 3000);
    }
</script>
{% endblock %}
